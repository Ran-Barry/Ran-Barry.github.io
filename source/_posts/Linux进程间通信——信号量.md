---
title: Linux进程间通信——信号量
date: 2020-10-29 11:30:18
tags: Linux进程间通信
---

## Linux进程间通信——信号量

### 信号量简介

#### 为什么需要信号量

为了防止出现因多个程序同时访问一个共享资源而引发的一系列问题，我们需要一种方法，它可以通过生成并使用令牌来授权，在任一时刻只能有一个执行线程访问代码的临界区域。临界区域是指执行数据更新的代码需要独占式地执行。而信号量就可以提供这样的一种访问机制，让一个临界区同一时间只有一个线程在访问它，也就是说信号量是用来调协进程对共享资源的访问的。

信号量是一种特殊的变量，访问具有原子性。

只允许对它进行两个操作：

1) 等待信号量

当信号量值为0时，程序等待；当信号量值大于0时，信号量减1，程序继续运行。

2) 发送信号量

将信号量值加1。

#### 信号量的工作原理

由于信号量只能进行两种操作等待和发送信号，即P(sv)和V(sv),他们的行为是这样的：
P(sv)：如果sv的值大于零，就给它减1；如果它的值为零，就挂起该进程的执行
V(sv)：如果有其他进程因等待sv而被挂起，就让它恢复运行，如果没有进程因等待sv而挂起，就给它加1.

举个例子，就是两个进程共享信号量sv，一旦其中一个进程执行了P(sv)操作，它将得到信号量，并可以进入临界区，使sv减1。而第二个进程将被阻止进入临界区，因为当它试图执行P(sv)时，sv为0，它会被挂起以等待第一个进程离开临界区域并执行V(sv)释放信号量，这时第二个进程就可以恢复执行。

### 信号量使用

Linux提供了一组精心设计的信号量接口来对信号进行操作，它们不只是针对二进制信号量，下面将会对这些函数进行介绍，但请注意，这些函数都是用来对成组的信号量值进行操作的。它们声明在头文件sys/sem.h中。

#### semget函数

它的作用是创建一个新信号量或取得一个已有信号量，原型为：

```c
int semget(key_t key,int num_sems,int sem_flags);
```

**key:** 整数值（唯一非零），
不相关的进程可以通过它访问一个信号量，它代表程序可能要使用的某个资源，程序对所有信号量的访问都是间接的，程序先通过调用semget函数并提供一个键，再由系统生成一个相应的信号标识符（semget函数的返回值），只有semget函数才直接使用信号量键，所有其他的信号量函数使用由semget函数返回的信号量标识符。如果多个程序使用相同的key值，key将负责协调工作。

**num_sems:** 指定需要的信号量数目，值几乎总是1。

**sem_flags:** 是一组标志，当想要当信号量不存在时创建一个新的信号量，可以和值IPC_CREAT做按位或操作。设置了IPC_CREAT标志后，即使给出的键是一个已有信号量的键，也不会产生错误。而IPC_CREAT | IPC_EXCL则可以创建一个新的，唯一的信号量，如果信号量已存在，返回一个错误。

semget函数成功返回一个相应信号标识符（非零），失败返回-1.

#### semop函数

它的作用是改变信号量的值，原型为：

```c
int semop(int sem_id,struct sembuf *sem_opa,size_t num_sem_ops);
```

**sem_id:** 由semget返回的信号量标识符**sembuf:** 结构如下：

```c
struct sembuf{
    short sem_num;//除非使用一组信号量，否则它为0
    short sem_op;//信号量在一次操作中需要改变的数据，通常是两个数，一个是-1，即P（等待）操作
    //一个是+1，即V（发送信号）操作
    short sem_flg;//通常SEM_UNDO，使操作系统跟踪信号
    //并在进程没有释放信号量终止时，操作系统释放信号量
};
```

**num_sem_ops:** 进行操作信号量的个数，即sops结构变量的个数，需大于或等于1.此值常等于1，只完成对一个信号量的操作。

semop函数成功返回信号量集的标识符，错误返回-1；

#### semctl函数

该函数用来直接控制信号量信息，它的原型为：

```c
int semctl(int sem_id,int sem_num,int command,[union semun sem_union]);
```

**sem_id:** 信号量集标识符
**sem_mum:** 信号量集数组上的下标，表示某一个信号量
**command:** 有两个值SETVAL,IPC_RMID，分别表示初始化和删除信号量。

如果有第四个参数，它通常是一个union semum结构，定义如下：

```c
union semun{
    int val;
    struct semid_ds *buf;
    unsigned short *arry;
};
```

一般用到的是val,表示要传给信号量的初始值。

semct函数成功返回大于或等于0，失败返回-1