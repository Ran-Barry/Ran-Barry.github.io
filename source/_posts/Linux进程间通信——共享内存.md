---
title: Linux进程间通信——共享内存
date: 2020-10-29 12:20:34
tags: Linux进程间通信
---

## Linux进程间通信——共享内存

### 共享内存简介

#### 什么是共享内存

共享内存就是允许两个不相关的进程访问同一个逻辑内存。共享内存是在两个正在运行的进程之间共享和传递数据的一种非常有效的方式。不同进程之间共享的内存通常安排为同一段物理内存。进程可以将同一段共享内存连接到它们自己的地址空间中，所有进程都可以访问共享内存中的地址，就好像它们是由用C语言函数malloc()分配的内存一样。而如果某个进程向共享内存写入数据，所做的改动将立即影响到可以访问同一段共享内存的任何其他进程。
<!--more-->
特别提醒：共享内存并未提供同步机制，也就是说，在第一个进程结束对共享内存的写操作之前，并无自动机制可以阻止第二个进程开始对它进行读取。所以我们通常需要用其他的机制来同步对共享内存的访问，例如信号量。

### 共享内存使用

使用共享内存进行进程通信时需要用到四个函数：shmget(),shmat(),shmdt(),shmctl()。这四个函数的使用需要声明sys/shm.h头文件

#### shmget函数

该函数用来创建共享内存，函数原型：
> int shmget(key_t key,size_t size,int shmflg);

shmget()用来获得共享内存区域的ID（如果不存在该共享内存区域则创建一个新的共享内存区域）

参数解释：
**key_t key：** 共享内存标识符，两个不相关的进程之间我们可以自定义一个key来使用，若为父子进程的话，该标识符可为IPC_PRIVATE（需要在父子进程都可见的地方调用（即在创建子进程之前），否则不能实现内存的共享）。
**size：** 以字节为单位指定需要共享的内存容量
**shmflg:** 权限标志，它的作用与open函数的mode参数一样，如果要想在key标识的共享内存不存在时创建它的话，可以与IPC_CREAT做或操作。共享内存的权限标志与文件的读写权限一样，举例来说，0644,它表示允许一个进程创建的共享内存被内存创建者所拥有的进程向共享内存读取和写入数据，同时其他用户创建的进程只能读取共享内存。

IPC_CREAT   如果共享内存不存在，则创建一个共享内存，否则打开操作。    
IPC_EXCL    只有在共享内存不存在的时候，新的共享内存才建立，否则就产生错误。

调用成功返回共享内存的标识符，失败返回-1

#### shmat函数

第一次创建完共享内存时，它还不能被任何进程访问，shmat函数的作用就是用来启动对该共享内存的访问，并把共享内存连接到当前进程的地址空间。它的原型如下：

```c
void *shmat(int shm_id,const void *shm_addr,int shmflg);
```

**shm_id:** 共享内存标识。
**shm_addr:** 指定共享内存连接到当前进程中的地址位置，通常为空，表示让系统来选择共享内存的地址。
**shm_flg:** 一组标志位，通常为0。

调用成功时返回一个指向共享内存第一个字节的指针，如果调用失败返回-1.

#### shmdt函数

该函数用于将共享内存从当前进程中分离。注意，将共享内存分离并不是删除它，只是使该共享内存对当前进程不再可用。它的原型如下：

```c
int shmctl(int shm_id, int command, struct shmid_ds *buf);
```

**shmaddr** shmatt函数返回的地址指针

调用成功时返回0，失败时返回-1.

#### shmctl函数

与信号量的semctl函数一样，用来控制共享内存，它的原型如下：

```c
int shmctl(int shm_id, int command, struct shmid_ds *buf);
```

**shm_id:** shmget返回共享内存标识符
**command：** 要采取的操作，可以取下面三个值：

* IPC_STAT：把shmid_ds结构中的数据设置为共享内存的当前关联值，即用共享内存的当前关联值覆盖shmid_ds的值。
* IPC_SET：如果进程有足够的权限，就把共享内存的当前关联值设置为shmid_ds结构中给出的值
* IPC_RMID：删除共享内存段

**buf：** 一个结构指针，指向共享内存模式和访问权限的结构
shmid_ds结构至少包括以下成员：

```c
struct shmid_ds
{
    uid_t shm_perm.uid;
    uid_t shm_perm.git;
    mode_t shm_perm.mode;
};
```

### 使用共享内存的优缺点

#### 优点

使用共享内存进行进程间的通信非常方便，而且函数的接口也简单，数据的共享还使进程间的数据不用传送，而是直接访问内存，也加快了程序的效率。同时，它也不像匿名管道那样要求通信的进程有一定的父子关系。

#### 缺点

共享内存没有提供同步的机制，这使得我们在使用共享内存进行进程间通信时，往往要借助其他的手段来进行进程间的同步工作。
